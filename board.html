<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chess Game</title>
    
    <!-- Import chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" 
          xintegrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCENIKhzaoKTJeRyOTpf" 
          crossorigin="anonymous">

    <!-- Import Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import chess libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" 
            xintegrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" 
            xintegrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3iGDIPd44a5uU9aoJe7q5eBoNMtqrA6WhY" 
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js" 
            xintegrity="sha384-s3XgLpvmHyscVpijnseAmyeGvoik5kUogMLnH/mU1pS5MunYSveOXzBEpstpdlDk" 
            crossorigin="anonymous"></script>

    <style>
        /* Custom styles for the chess game */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .board-container {
            width: 90vw;
            max-width: 500px; /* A good size for most screens */
            margin: 0 auto;
        }
        /* Style for highlighting possible moves */
        .highlight-move {
            box-shadow: inset 0 0 3px 3px rgba(20, 85, 30, 0.5);
        }
        /* Animation for feedback text */
        .feedback-animation {
            animation: fadeInOut 2.5s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-bold text-gray-700 mb-6">Chess Game</h1>

        <!-- Main content area: board and info panel -->
        <div class="flex flex-col items-center">

            <!-- Game Setup -->
            <div id="game-setup" class="w-full max-w-md text-center">
                <div id="mode-selection">
                    <h2 class="text-2xl font-bold mb-4">Choose Game Mode</h2>
                    <button id="play-human" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg m-2">Play vs Human</button>
                    <button id="play-computer" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg m-2">Play vs Computer</button>
                </div>
                <div id="difficulty-selection" class="hidden mt-4">
                    <h2 class="text-2xl font-bold mb-4">Choose Difficulty</h2>
                    <button data-level="1" class="difficulty-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg m-1">Easy</button>
                    <button data-level="5" class="difficulty-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg m-1">Medium</button>
                    <button data-level="10" class="difficulty-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg m-1">Hard</button>
                </div>
            </div>

            <!-- Game Area (initially hidden) -->
            <div id="game-area" class="hidden w-full flex flex-col items-center">
                <!-- Chessboard container -->
                <div id="board-container" class="board-container shadow-lg rounded-lg overflow-hidden mb-6">
                    <div id="myBoard" class="w-full"></div>
                </div>

                <!-- Game Info Panel Below Board -->
                <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-lg space-y-4">
                    
                    <!-- Turn Indicator -->
                    <div id="turn-indicator" class="text-center text-3xl font-bold text-gray-700 h-10 flex items-center justify-center">
                        White to Move
                    </div>

                    <!-- Win Chance Display -->
                    <div class="w-full">
                        <h3 class="text-center text-lg font-semibold mb-2 text-gray-500">Win Chance</h3>
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span id="white-win-chance">⚪ White: 50%</span>
                            <span id="black-win-chance">⚫ Black: 50%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-4 mt-1 flex overflow-hidden">
                            <div id="win-chance-bar" class="bg-blue-500 h-full rounded-full transition-all duration-500" style="width: 50%;"></div>
                        </div>
                    </div>

                    <!-- Bottom row for button and feedback -->
                    <div class="flex justify-between items-center pt-2">
                        <button id="resetButton" class="w-2/5 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            New Game
                        </button>
                        <div id="move-feedback" class="text-right text-xl font-bold h-8 w-3/5">
                            <!-- Feedback will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const boardEl = $('#myBoard');
        const turnIndicatorEl = $('#turn-indicator');
        const whiteWinChanceEl = $('#white-win-chance');
        const blackWinChanceEl = $('#black-win-chance');
        const winChanceBarEl = $('#win-chance-bar');
        const moveFeedbackEl = $('#move-feedback');
        const resetButton = $('#resetButton');
        const gameSetupEl = $('#game-setup');
        const gameAreaEl = $('#game-area');
        const modeSelectionEl = $('#mode-selection');
        const difficultySelectionEl = $('#difficulty-selection');

        // --- Game Logic ---
        let board = null;
        const game = new Chess();
        let stockfish = null; // Will be initialized later
        let gameMode = 'human'; // 'human' or 'computer'
        let playerColor = 'w';
        let computerLevel = 5;

        // --- Move Analysis Simulation ---
        const moveAnalyses = [
            { text: 'Brilliant!', color: 'text-green-500' },
            { text: 'Excellent!', color: 'text-blue-500' },
            { text: 'Good Move', color: 'text-cyan-500' },
            { text: 'Inaccuracy', color: 'text-yellow-600' },
            { text: 'Mistake', color: 'text-orange-500' },
            { text: 'Blunder!', color: 'text-red-600' }
        ];
        
        const pieceValues = { 'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 0 };

        // --- Functions ---
        
        // FIX: Load Stockfish worker from a Blob to avoid cross-origin errors.
        async function initializeStockfish() {
            try {
                const response = await fetch("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js");
                const workerScript = await response.text();
                const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(workerBlob);
                stockfish = new Worker(workerUrl);

                stockfish.onmessage = function(event) {
                    const message = event.data;
                    if (message.startsWith('bestmove')) {
                        const move = message.substring(9, 13);
                        game.move({ from: move.substring(0, 2), to: move.substring(2, 4), promotion: 'q' });
                        board.position(game.fen());
                        updateStatus();
                        analyzeMove();
                    }
                };
            } catch (error) {
                console.error("Failed to initialize Stockfish worker:", error);
                $('#play-computer').prop('disabled', true).text('Computer Unavailable').removeClass('bg-green-500 hover:bg-green-600').addClass('bg-gray-400');
            }
        }

        function getComputerMove() {
            if (!stockfish) {
                console.error("Stockfish is not initialized.");
                return;
            }
            turnIndicatorEl.text('Computer is thinking...');
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go depth ' + computerLevel);
        }
        
        function highlightMove(square) {
            boardEl.find('.square-' + square).addClass('highlight-move');
        }
        
        function removeHighlights() {
            boardEl.find('.square-55d63').removeClass('highlight-move');
        }

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if (gameMode === 'computer' && game.turn() !== playerColor) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
            const moves = game.moves({ square: source, verbose: true });
            if (moves.length === 0) return;
            moves.forEach(move => highlightMove(move.to));
        }

        function onDrop(source, target) {
            removeHighlights();
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            if (move === null) return 'snapback';
            
            updateStatus();
            analyzeMove();

            if (gameMode === 'computer' && !game.game_over()) {
                window.setTimeout(getComputerMove, 250);
            }
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function updateWinChance() {
            let whiteMaterial = 0, blackMaterial = 0;
            // FIX: Generate squares manually as game.SQUARES is not a valid property.
            const squares = [];
            const files = 'abcdefgh';
            for (let i = 0; i < files.length; i++) {
                for (let j = 1; j <= 8; j++) {
                    squares.push(files[i] + j);
                }
            }
            squares.forEach(square => {
                const piece = game.get(square);
                if (piece) {
                    const value = pieceValues[piece.type];
                    if (piece.color === 'w') whiteMaterial += value;
                    else blackMaterial += value;
                }
            });
            const totalMaterial = whiteMaterial + blackMaterial;
            if (totalMaterial === 0) {
                whiteWinChanceEl.text('⚪ White: 50%');
                blackWinChanceEl.text('⚫ Black: 50%');
                winChanceBarEl.css('width', '50%');
                return;
            }
            let whiteChance = (whiteMaterial / totalMaterial) * 100;
            if (game.turn() === 'w') whiteChance += 2; else whiteChance -= 2;
            whiteChance = Math.max(5, Math.min(95, whiteChance));
            const blackChance = 100 - whiteChance;
            whiteWinChanceEl.text(`⚪ White: ${whiteChance.toFixed(0)}%`);
            blackWinChanceEl.text(`⚫ Black: ${blackChance.toFixed(0)}%`);
            winChanceBarEl.css('width', `${whiteChance.toFixed(0)}%`);
        }

        function updateStatus() {
            const moveColor = game.turn() === 'w' ? 'White' : 'Black';
            if (game.in_checkmate()) {
                turnIndicatorEl.text(`Checkmate! ${moveColor === 'White' ? 'Black' : 'White'} wins.`);
            } else if (game.in_draw()) {
                turnIndicatorEl.text('Draw!');
            } else {
                let status = `${moveColor} to Move`;
                if (game.in_check()) status += ' (in check)';
                turnIndicatorEl.text(status);
            }
            updateWinChance();
        }
        
        function analyzeMove() {
            const randomAnalysis = moveAnalyses[Math.floor(Math.random() * moveAnalyses.length)];
            const feedbackSpan = $('<span></span>')
                .text(randomAnalysis.text)
                .removeClass()
                .addClass(randomAnalysis.color + ' feedback-animation');
            moveFeedbackEl.html(feedbackSpan);
        }

        function startGame() {
            gameSetupEl.addClass('hidden');
            gameAreaEl.removeClass('hidden');
            game.reset();
            board.start();
            updateStatus();
            moveFeedbackEl.empty();
        }

        function resetGame() {
            gameAreaEl.addClass('hidden');
            gameSetupEl.removeClass('hidden');
            modeSelectionEl.removeClass('hidden');
            difficultySelectionEl.addClass('hidden');
        }

        // --- Event Listeners ---
        $('#play-human').on('click', () => {
            gameMode = 'human';
            startGame();
        });

        $('#play-computer').on('click', () => {
            modeSelectionEl.addClass('hidden');
            difficultySelectionEl.removeClass('hidden');
        });

        $('.difficulty-btn').on('click', (e) => {
            computerLevel = $(e.target).data('level');
            gameMode = 'computer';
            playerColor = 'w'; // Player is always white vs computer for now
            startGame();
        });

        resetButton.on('click', resetGame);
        $(window).resize(() => { if(board) board.resize(); });
        
        // --- Board and AI Initialization ---
        $(document).ready(function() {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('myBoard', config);
            initializeStockfish();
        });
    </script>
</body>
</html>
<!-- will debug soon -->
